<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ’– ìš°ë¦¬ ë°˜ ìê¸°ì†Œê°œ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap');

  body {
    font-family: 'Nanum Pen Script', cursive;
    background-color: #ffe4e1;
    padding: 20px;
    margin: 0;
    min-height: 100vh;
  }

  h1 {
    text-align: center;
    color: #ff6f91;
    font-size: 2.8rem;
    margin-bottom: 20px;
    text-shadow: 1px 1px 2px #fce4ec;
  }

  .input-container {
    background: #fff0f5;
    border-radius: 20px;
    padding: 20px;
    max-width: 480px;
    margin: 0 auto 20px;
    box-shadow: 0 5px 15px rgba(255,105,145,0.3);
  }

  input, textarea {
    width: 90%;
    padding: 10px;
    margin: 10px auto;
    border-radius: 15px;
    border: 2px solid #ffb6c1;
    display: block;
    font-size: 1.1rem;
    outline: none;
  }
  textarea {
    height: 70px;
    resize: none;
  }

  button {
    background-color: #ff6f91;
    border: none;
    color: white;
    font-weight: bold;
    font-size: 1.1rem;
    padding: 8px 20px;
    border-radius: 20px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin: 5px;
  }
  button:hover {
    background-color: #ff4d72;
  }

  #sortControls {
    text-align: center;
    margin-bottom: 20px;
  }

  #introList {
    max-width: 960px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    max-height: 600px;
    overflow-y: auto;
    padding-bottom: 15px;
  }

  .card {
    background: #fff;
    border-radius: 25px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(255,105,145,0.2);
    position: relative;
    font-size: 1.1rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .card h3 {
    color: #ff6f91;
    margin: 0 0 6px 0;
  }

  .card p {
    margin: 4px 0;
    color: #555;
    word-break: keep-all;
  }

  .card small {
    display: block;
    margin-top: 8px;
    color: #888;
    font-size: 0.9rem;
  }

  .actions {
    margin-top: 12px;
    text-align: right;
  }

  .actions button {
    border: none;
    background: none;
    cursor: pointer;
    font-size: 1.5rem;
    margin-left: 10px;
    transition: transform 0.15s ease;
  }

  .actions button:hover {
    transform: scale(1.2);
  }

  .like-btn { color: #ff6f91; }
  .delete-btn { color: #aaa; }

  .like-animate {
    animation: like-pop 0.4s ease forwards;
  }

  @keyframes like-pop {
    0% { transform: scale(1); color: #ff6f91; }
    50% { transform: scale(1.6); color: #ff416c; }
    100% { transform: scale(1); color: #ff6f91; }
  }

  @media (max-width: 600px) {
    #introList {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      max-height: 500px;
    }
  }
</style>
</head>
<body>

<h1>ìš°ë¦¬ ë°˜ ìê¸°ì†Œê°œ ğŸ’Œ</h1>

<div class="input-container">
  <input type="text" id="nameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="15" />
  <input type="text" id="hobbyInput" placeholder="ì·¨ë¯¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" maxlength="30" />
  <input type="text" id="skillInput" placeholder="íŠ¹ê¸°ë¥¼ ì…ë ¥í•˜ì„¸ìš”" maxlength="30" />
  <textarea id="introInput" placeholder="ê°„ë‹¨í•œ ìê¸°ì†Œê°œë¥¼ ì‘ì„±í•˜ì„¸ìš” (ìµœëŒ€ 100ì)" maxlength="100"></textarea>
  <button id="postBtn">ìê¸°ì†Œê°œ ì˜¬ë¦¬ê¸°</button>
</div>

<div id="sortControls">
  <button id="sortLatest">ì •ë ¬: ìµœì‹ ìˆœ</button>
  <button id="sortLikes">ì •ë ¬: ì¢‹ì•„ìš”ìˆœ</button>
</div>

<div id="introList"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCtBTzq6aIgRzWDB2gfG2LBK19Y4TYCj4w",
    authDomain: "summer-memory-bc163.firebaseapp.com",
    databaseURL: "https://summer-memory-bc163-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "summer-memory-bc163",
    storageBucket: "summer-memory-bc163.firebasestorage.app",
    messagingSenderId: "1014179818008",
    appId: "1:1014179818008:web:4570325a33a90582d2b16d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let currentUserName = localStorage.getItem("currentUserName") || "";
  let currentSort = "latest"; // ê¸°ë³¸ ì •ë ¬: ìµœì‹ ìˆœ
  let introData = []; // ë©”ëª¨ë¦¬ì— ë°ì´í„° ë³´ê´€

  const postBtn = document.getElementById("postBtn");
  postBtn.addEventListener("click", () => {
    const name = document.getElementById("nameInput").value.trim();
    const hobby = document.getElementById("hobbyInput").value.trim();
    const skill = document.getElementById("skillInput").value.trim();
    const intro = document.getElementById("introInput").value.trim();

    if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    if (!hobby) return alert("ì·¨ë¯¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    if (!skill) return alert("íŠ¹ê¸°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    if (!intro) return alert("ìê¸°ì†Œê°œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!");

    currentUserName = name;
    localStorage.setItem("currentUserName", name);

    const newRef = push(ref(db, "introductions"));
    set(newRef, {
      name, hobby, skill, intro,
      likes: 0,
      likedBy: {},
      author: name,
      timestamp: Date.now()
    });

    document.getElementById("nameInput").value = "";
    document.getElementById("hobbyInput").value = "";
    document.getElementById("skillInput").value = "";
    document.getElementById("introInput").value = "";
  });

  function renderComments() {
    const list = document.getElementById("introList");
    list.innerHTML = "";

    let sorted = [...introData];
    if (currentSort === "latest") {
      sorted.sort((a, b) => b.timestamp - a.timestamp);
    } else if (currentSort === "likes") {
      sorted.sort((a, b) => (b.likes || 0) - (a.likes || 0));
    }

    sorted.forEach(item => {
      const card = document.createElement("div");
      card.classList.add("card");
      const date = item.timestamp ? new Date(item.timestamp).toLocaleString("ko-KR") : "";

      card.innerHTML = `
        <h3>${escapeHtml(item.name)}</h3>
        <p><b>ì·¨ë¯¸:</b> ${escapeHtml(item.hobby)}</p>
        <p><b>íŠ¹ê¸°:</b> ${escapeHtml(item.skill)}</p>
        <p><b>ìê¸°ì†Œê°œ:</b> ${escapeHtml(item.intro)}</p>
        <small>ì‘ì„±ì¼: ${date}</small>
        <div class="actions">
          <button class="like-btn" title="ì¢‹ì•„ìš”" data-id="${item.id}">ğŸ‘ ${item.likes || 0}</button>
          <button class="delete-btn" title="ì‚­ì œ" data-id="${item.id}">ğŸ—‘ï¸</button>
        </div>
      `;
      list.appendChild(card);
    });

    // ì¢‹ì•„ìš” ì´ë²¤íŠ¸
    document.querySelectorAll(".like-btn").forEach(btn => {
      btn.onclick = async () => {
        if (!currentUserName) return alert("ë¨¼ì € ìê¸°ì†Œê°œë¥¼ ì˜¬ë ¤ì£¼ì„¸ìš”!");
        const id = btn.getAttribute("data-id");
        const commentRef = ref(db, "introductions/" + id);
        const snapshot = await get(commentRef);
        if (snapshot.exists()) {
          const data = snapshot.val();
          if (data.likedBy && data.likedBy[currentUserName]) {
            return alert("ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì…¨ì–´ìš”!");
          }
          const likedBy = data.likedBy || {};
          likedBy[currentUserName] = true;
          await update(commentRef, {
            likes: (data.likes || 0) + 1,
            likedBy
          });
          btn.textContent = `ğŸ‘ ${(data.likes || 0) + 1}`;
          btn.classList.add("like-animate");
          setTimeout(() => btn.classList.remove("like-animate"), 400);
        }
      };
    });

    // ì‚­ì œ ì´ë²¤íŠ¸
    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.onclick = async () => {
        if (!currentUserName) return alert("ë¨¼ì € ìê¸°ì†Œê°œë¥¼ ì˜¬ë ¤ì£¼ì„¸ìš”!");
        const id = btn.getAttribute("data-id");
        const commentRef = ref(db, "introductions/" + id);
        const snapshot = await get(commentRef);
        if (snapshot.exists()) {
          const data = snapshot.val();
          if (data.author !== currentUserName) {
            return alert("ë³¸ì¸ë§Œ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”!");
          }
          if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ì–´ìš”?")) {
            await remove(commentRef);
          }
        }
      };
    });
  }

  // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const listRef = ref(db, "introductions");
  onValue(listRef, (snapshot) => {
    introData = [];
    snapshot.forEach(childSnap => {
      introData.push({ id: childSnap.key, ...childSnap.val() });
    });
    renderComments();
  });

  // ì •ë ¬ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById("sortLatest").onclick = () => {
    currentSort = "latest";
    renderComments();
  };
  document.getElementById("sortLikes").onclick = () => {
    currentSort = "likes";
    renderComments();
  };

  function escapeHtml(text) {
    if (!text) return "";
    return text.replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[m]));
  }
</script>

</body>
</html>
